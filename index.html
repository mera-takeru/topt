<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>pertonal -パートナル-</title>
  
  <!-- 共通CSSの読み込み -->
  <link rel="stylesheet" href="style.css">
  
  <!-- シェアされた際のデフォルト情報 -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="パートナル - 音と色の性格診断">
  <meta name="twitter:description" content="音と色であなたの性格を診断！MBTIの次はコレ！今すぐ無料でチェック！">
  <meta name="twitter:image" content="https://ipfs.io/ipfs/bafybeifuttq27ioeycupsnmuj4u2kuvjtmg4ibhtxualf6mti2yxa5abbe">
  <meta property="og:image" content="https://ipfs.io/ipfs/bafybeifuttq27ioeycupsnmuj4u2kuvjtmg4ibhtxualf6mti2yxa5abbe">
</head>
<body>

  <header>
    <nav class="header-nav">
      <a href="./about.html">パートナルとは</a><span class="divider">|</span>
      <a href="./faq.html">よくある質問</a><span class="divider">|</span>
      <a href="https://forms.gle/PstFm54KustR4zKs6">お問い合わせ</a>
    </nav>
  </header>

  <div class="container">
    <h1>
      <span class="title-topt">
        <span class="title-english">pertonal</span>
        <span class="title-japanese"> -パートナル-</span>
      </span>
      <span class="title-sub">「音」×「色」＝ New「性格診断」</span>
    </h1>

    <!-- スタート画面 -->
    <div id="startScreen" class="screen active">
      　<div class="start-image">
  <video autoplay loop muted playsinline alt="メイン画像">
    <source src="https://gray-magnificent-deer-836.mypinata.cloud/ipfs/bafybeieecwryua54rzenirkaknhrknenmstocag6vbjykxdoxc7p3eswyq" 
            media="(min-width: 601px)" 
            type="video/mp4">
            
    <source src="https://gray-magnificent-deer-836.mypinata.cloud/ipfs/bafybeiesn767okn2gtxqyipfcyngrceg2277h4emw6s2emi7yw3ozt767q" 
            media="(max-width: 600px)" 
            type="video/mp4">
            
    お使いのブラウザは動画の再生に対応していません。
  </video>
</div>
   　
      <button id="startBtn">▶︎▶︎▶︎ 今すぐ無料診断 ◀︎◀︎◀︎</button>
    </div>

    <!-- 質問画面 -->
    <div id="questionScreen" class="screen">
      <div class="progress-bar"><div id="progInner" class="progress-inner"></div></div>
      <div class="question"><h2 id="questionText"></h2></div>
      <ul id="optionsList" class="options"></ul>
      <div class="nav"><button id="backBtn">◀︎ 1つ前へ</button></div>
    </div>
  </div>

  <footer>
    <nav class="footer-nav">
      <a href="./terms.html">利用規約</a><span class="divider">|</span>
      <a href="./privacy.html">プライバシーポリシー</a><span class="divider">|</span>
      <a href="./operator.html">運営者情報</a>
    </nav>
    <p class="copyright">&copy; 2025 pertonal by mera takeru. All rights reserved.</p>
  </footer>

  <!-- 共通データ（質問など）を読み込む -->
  <script src="data.js"></script>
  
  <!-- このページ専用のロジック -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 現在の質問番号とユーザーの回答を保存する変数
      let currentQuestionIndex = 0;
      const userAnswers = Array(questions.length).fill(null);

      // HTML要素を取得
      const startBtn = document.getElementById('startBtn');
      const backBtn = document.getElementById('backBtn');
      const startScreen = document.getElementById('startScreen');
      const questionScreen = document.getElementById('questionScreen');
      const questionText = document.getElementById('questionText');
      const optionsList = document.getElementById('optionsList');
      const progInner = document.getElementById('progInner');

      // 画面を切り替えるための関数
      function showScreen(screen) {
        startScreen.classList.remove('active');
        questionScreen.classList.remove('active');
        screen.classList.add('active');
      }

      // 質問と選択肢を表示する関数
      function renderQuestion() {
        const q = questions[currentQuestionIndex];
        questionText.textContent = q.text;
        progInner.style.width = `${(currentQuestionIndex / questions.length) * 100}%`;
        optionsList.innerHTML = '';

        // 選択肢のボタンを生成
        q.options.forEach((opt, idx) => {
          const li = document.createElement('li');
          if (userAnswers[currentQuestionIndex] === idx) {
            li.classList.add('selected');
          }
          const btn = document.createElement('button');
          btn.textContent = opt.text;
          btn.onclick = () => {
            userAnswers[currentQuestionIndex] = idx; // 回答を保存
            // 次の質問へ進むか、結果を計算するかを判断
            if (currentQuestionIndex < questions.length - 1) {
              currentQuestionIndex++;
              renderQuestion();
            } else {
              calculateAndRedirect();
            }
          };
          li.appendChild(btn);
          optionsList.appendChild(li);
        });

        // 「戻る」ボタンの表示・非表示を切り替え
        backBtn.style.display = currentQuestionIndex > 0 ? 'inline-block' : 'none';
      }

            async function calculateAndRedirect() { // asyncキーワードを追加
        // 調号の数と長調優先を反映した優先順位リスト
        const tieBreakerOrder = [
          "C", "am", "G", "em", "F", "dm", "D", "bm", "B♭", "gm",
          "A", "f♯m", "E♭", "cm", "E", "c♯m", "A♭", "fm",
          "B", "g♯m", "D♭", "b♭m", "F♯", "e♭m"
        ];
        
        const totals = {};
        questions.forEach((q, qi) => {
          const selectedOptionIndex = userAnswers[qi];
          if (selectedOptionIndex !== null) {
            const points = q.options[selectedOptionIndex].points;
            Object.entries(points).forEach(([key, value]) => {
              totals[key] = (totals[key] || 0) + value;
            });
          }
        });
        
        if (Object.keys(totals).length === 0) {
          alert('エラーが発生しました。もう一度お試しください。');
          showScreen(startScreen);
          return;
        }

        const maxScore = Math.max(...Object.values(totals));
        const tiedResults = Object.keys(totals).filter(key => totals[key] === maxScore);

        let resultKey;

        if (tiedResults.length > 1) {
          resultKey = tieBreakerOrder.find(key => tiedResults.includes(key));
        } else {
          resultKey = tiedResults[0];
        }

        if (resultKey) {
          // ▼▼▼ ここからが追加・修正部分 ▼▼▼
          try {
            // ステップ1でコピーしたあなたのウェブアプリURLをここに貼り付け
            const webAppUrl = 'https://script.google.com/macros/s/AKfycby85hMd3E8tD_p5JGqQG_eG4PMW-TFCg0EHhSOY7Eoht-CSoiDuG_2eqfgBWOvYaOM/exec'; 
            
            // 診断結果をGoogle Apps Scriptに送信
            await fetch(webAppUrl, {
              method: 'POST',
              mode: 'no-cors', // CORSエラーを回避するためのおまじない
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: JSON.stringify({ partonal: resultKey }),
            });

          } catch (error) {
            // サーバーへの送信が失敗しても、ユーザーの診断は続行させる
            console.error('結果の送信に失敗しました:', error);
          }
          // ▲▲▲ ここまで ▲▲▲

          // 診断結果ページへの移動（ここは元のまま）
          const fileName = resultKey.replace('♯', 's').replace('♭', 'b');
          window.location.href = `${fileName}.html`;
        } else {
          alert('エラーが発生しました。もう一度お試しください。');
          showScreen(startScreen);
        }
      }

      startBtn.onclick = () => {
        currentQuestionIndex = 0;
        userAnswers.fill(null);
        renderQuestion();
        showScreen(questionScreen);
      };

      backBtn.onclick = () => {
        if (currentQuestionIndex > 0) {
          currentQuestionIndex--;
          renderQuestion();
        }
      };
    });
  </script>
</body>
</html>

